# 通讯协议

通讯协议为硬件设备与服务器之间通信的规范，只有充分了解设备和平台的通讯协议才能正确的将设备连接上MyHome服务器。因此，如果你DIY自己的硬件设备，必须充分了解此章节内容。


## 数据传输协议

为了能连接上智能家居平台，原理上可以使用多种协议，这些通讯数据协议包含：HTTP、socket、mqtt等，**但是最终平台和设备之间的协议为MQTT**

各种数据传输协议优劣势分析：

1. HTTP协议：作为目前web端使用最广泛的数据传输协议工作在OSI第7层，是一种请求/响应的数据传输协议。也就是说数据必须发起请求，服务端响应。请求/响应这种模式，在web端比较常见，用户点击数据响应并显示在浏览器。但是，如果想持续的、实时的传输数据，只能通过轮询的形式进行数据的传输，轮询对于物联网设备是不现实的。
- 首先也是最重要的一点会导致服务端出现高并发的情况，因为物联网设备通常都不是几个几十个设备，大量的设备统统轮询服务器端，将直接导致服务器端并发量异常的高，这对服务端是灾难性的压力。
- 其次，由于HTTP协议是明文协议，任何抓包工具都能轻松抓取到通讯数据的内容，这对物联网设备也是非常致命的（虽然可以使用HTTPS进行规避，但是物联网设备处理器能力普遍偏低，运行HTTPS协议栈也是一个不小的挑战，整机消耗在协议栈上的性能将非常高）
2. socket协议：socket协议作为非常底层的通讯协议，协议的内容、心跳等等统统需要程序员来自行维护，这对于绝大多数程序员来说是个非常深奥的领域，因此我们也不使用。
3. websocket协议：顾名思义主要是面向web端的实现实时推送的协议，我们的硬件设备不需要web端那么“重”的协议栈，以兼顾低处理能力的mcu。
4. mqtt协议：如果是做后端开发的小伙伴基本上都知道什么是消息队列，mqtt就是消息队列的一种（这个解释将方便后端程序员理解mqtt协议）。MQTT协议采用发布/订阅模式，所有的物联网终端都通过TCP连接到云端，云端通过主题的方式管理各个设备关注的通讯内容。既然mqtt是一种发布/订阅模式，这将大大减少后台服务器的并发压力，后端只需要监听响应的队列处理消息即可。同时MQTT在协议设计时就考虑到不同设备的计算性能的差异，所以所有的协议都是采用二进制格式编解码，并且编解码格式都非常易于开发和实现。最小的数据包只有2个字节，对于低功耗低速网络也有很好的适应性。有非常完善的QOS机制，根据业务场景可以选择最多一次、至少一次、刚好一次三种消息送达模式。运行在TCP协议之上，同时支持TLS（TCP+SSL）协议，并且由于所有数据通信都经过云端，安全性得到了较好地保障。

## 通信内容协议

如今web开发领域基本上都使用JSON格式进行数据的传输，为了统一软件和硬件之间的规范。因此硬件设备和平台之间进行通讯的内容协议为[JSON](https://www.w3school.com.cn/json/index.asp)格式数据。

### 1.设备上报心跳

设备每30s上报一次心跳数据，平台将通过检测设备心跳书否存在判断设备是否离线。

#### Topic
${productKey}/${deviceId}/heartbeat

#### 权限

发布

#### 数据内容
```json

{
    "deviceId":"1",
    "status":true
}
```
### 2.设备监听平台下发控制

#### Topic
${productKey}/${deviceId}/controled

#### 权限

订阅

#### 数据内容

不同类型设备，所接收到的数据略有不同（不同协议内容可扩展，可以在社区提出自己的协议格式），同时在设备控制时**必须做设备ID判断是否是本设备**

- 设备-控制型-布尔型设备：

```json

{
    "deviceId":"1",
    "open":true
}
```
解释：数据中open字段true时标识设备开，false标识设备关。

### 3.设备上报自身状态

#### Topic
${productKey}/${deviceId}/report

#### 权限

发布

#### 数据内容

不同类型设备，上报数据略有不同（不同协议内容可扩展，可以在社区提出自己的协议格式

- 设备-控制型-布尔型设备：

```json

{
    "deviceId":"1",
    "open":true
}
```
解释：数据中open字段true时标识设备开，false标识设备关。